<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=450, height=120">
    <title>Deep of Night - Depth Rating</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@600;700;800&family=Cormorant+Garamond:wght@400;600&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --deep-night: #0a0514;
            --void-purple: #1a0f2e;
            --golden-flame: #d4af37;
            --arcane-gold: #ffdc73;
            --crimson-variant: #8b0000;
        }

        body {
            width: 450px;
            height: 120px;
            background: transparent;
            overflow: hidden;
            font-family: 'Cinzel', serif;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        /* Control Panel - Hidden by default, shown on interaction */
        .controls {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            width: 100%;
            min-height: 120px;
            background: rgba(10, 5, 20, 0.95);
            border: 1px solid var(--golden-flame);
            padding: 15px;
            border-radius: 4px;
            display: none;
            z-index: 1000;
            flex-direction: row;
            gap: 20px;
            align-items: center;
            justify-content: center;
        }

        body:hover .controls {
            display: flex;
        }

        .control-section {
            border-bottom: 1px solid rgba(212, 175, 55, 0.3);
            padding-bottom: 8px;
            margin-bottom: 8px;
        }

        .control-section:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }

        .section-title {
            color: var(--arcane-gold);
            font-size: 11px;
            font-weight: 600;
            margin-bottom: 6px;
            letter-spacing: 1px;
        }

        .control-row {
            display: flex;
            gap: 5px;
            align-items: center;
        }

        .controls input {
            width: 80px;
            padding: 5px;
            background: rgba(0, 0, 0, 0.5);
            border: 1px solid var(--golden-flame);
            color: var(--arcane-gold);
            font-family: 'Cormorant Garamond', serif;
            font-size: 14px;
            text-align: center;
        }

        .controls button {
            padding: 5px 12px;
            background: linear-gradient(135deg, rgba(26, 15, 46, 0.9), rgba(10, 5, 20, 0.9));
            border: 1px solid var(--golden-flame);
            color: var(--arcane-gold);
            font-family: 'Cinzel', serif;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .controls button:hover {
            background: linear-gradient(135deg, rgba(36, 25, 56, 0.9), rgba(20, 15, 30, 0.9));
            box-shadow: 0 0 10px rgba(212, 175, 55, 0.3);
        }

        .controls label {
            color: rgba(255, 255, 255, 0.7);
            font-size: 11px;
            font-family: 'Cormorant Garamond', serif;
        }

        /* Main Container */
        .depth-container {
            position: relative;
            background: transparent;
            padding: 10px;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        /* Left side - Icon */
        .icon-section {
            flex-shrink: 0;
        }

        .depth-icon {
            width: 80px;
            height: 80px;
            object-fit: contain;
            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.3));
        }

        /* Right side - Info */
        .info-section {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .depth-title {
            display: none;
        }

        .points-display {
            font-family: 'Cinzel', serif;
            font-size: 22px;
            font-weight: 600;
            color: #333;
            letter-spacing: 1px;
        }

        .points-value {
            color: #222;
            font-weight: 700;
            font-size: 24px;
        }

        .points-bar-container {
            width: 280px;
            height: 20px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 10px;
            overflow: hidden;
            position: relative;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        }

        .points-bar {
            height: 100%;
            background: linear-gradient(90deg,
                #2d1b4e 0%,
                #5e3a8c 40%,
                #8b5fbf 70%,
                #b088d4 100%);
            width: 0%;
            transition: width 0.5s ease-out;
            border-radius: 10px;
            position: relative;
            overflow: hidden;
            box-shadow: 0 0 8px rgba(139, 95, 191, 0.5);
        }

        .points-bar::after {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg,
                transparent,
                rgba(255, 255, 255, 0.4),
                transparent);
            animation: shimmer 2s infinite;
        }

        @keyframes shimmer {
            0% { left: -100%; }
            100% { left: 200%; }
        }
    </style>
</head>
<body>
    <!-- Interactive Controls (shown on hover) -->
    <div class="controls" hidden="hidden">
        <div class="control-section">
            <div class="section-title">TWITCH INTEGRATION</div>
            <div class="control-row">
                <label>Channel:</label>
                <input type="text" id="twitchChannel" placeholder="your_username" style="width: 140px;">
            </div>
            <div class="control-row">
                <button id="twitchToggle" onclick="toggleTwitch()">Connect</button>
                <span id="twitchStatus" style="color: rgba(255,255,255,0.5); font-size: 10px;">Disconnected</span>
            </div>
            <div style="color: rgba(255,255,255,0.5); font-size: 9px; line-height: 1.3; margin-top: 4px;">
                Command: !don [+/-]number<br>
                Only you & mods can use it
            </div>
        </div>

        <div class="control-section">
            <div class="section-title">MANUAL CONTROLS</div>
            <div class="control-row">
                <label>Points:</label>
                <input type="number" id="pointsInput" value="2500">
                <button onclick="updateFromInput()">Set Points</button>
            </div>
            <div class="control-row">
                <button onclick="subtractPoints(200)">-200</button>
                <button onclick="subtractPoints(100)">-100</button>
                <button onclick="addPoints(100)">+100</button>
                <button onclick="addPoints(200)">+200</button>
            </div>
        </div>
    </div>

    <div class="depth-container">
        <!-- Left: Depth Icon -->
        <div class="icon-section">
            <img id="depthIcon" class="depth-icon" src="images/depth-3.png" alt="Depth 3">
        </div>

        <!-- Right: Info -->
        <div class="info-section">
            <div class="points-bar-container">
                <div class="points-bar" id="pointsBar"></div>
            </div>
            <div class="points-display">
                <span class="points-value" id="currentPoints">2500</span> / <span id="nextRankPoints">4000</span>
            </div>
        </div>
    </div>

    <script>
        // Depth thresholds based on the game's ranking system
        const depthThresholds = [
            { depth: 1, min: 0, max: 1000 },
            { depth: 2, min: 1000, max: 2000 },
            { depth: 3, min: 2000, max: 4000 },
            { depth: 4, min: 4000, max: 6000 },
            { depth: 5, min: 6000, max: 9999 } // Depth 5 caps at 9999 visually
        ];

        // Icon URLs
        const depthIcons = {
            1: 'images/depth-1.png',
            2: 'images/depth-2.png',
            3: 'images/depth-3.png',
            4: 'images/depth-4.png',
            5: 'images/depth-5.png'
        };

        // Load points from localStorage or use default
        let currentPoints = parseInt(localStorage.getItem('deepOfNightPoints')) || 2500;

        // Twitch integration variables
        let twitchWs = null;
        let twitchConnected = false;
        let twitchChannel = localStorage.getItem('twitchChannel') || '';

        function getDepthFromPoints(points) {
            for (let i = depthThresholds.length - 1; i >= 0; i--) {
                if (points >= depthThresholds[i].min) {
                    return depthThresholds[i];
                }
            }
            return depthThresholds[0]; // Default to Depth 1
        }

        function updateDisplay() {
            const depthIconEl = document.getElementById('depthIcon');
            const currentPointsEl = document.getElementById('currentPoints');
            const nextRankPointsEl = document.getElementById('nextRankPoints');
            const pointsBarEl = document.getElementById('pointsBar');
            const pointsInputEl = document.getElementById('pointsInput');

            // Calculate current depth based on points
            const depthInfo = getDepthFromPoints(currentPoints);
            const currentDepth = depthInfo.depth;

            // Update depth icon
            depthIconEl.src = depthIcons[currentDepth];
            depthIconEl.alt = `Depth ${currentDepth}`;

            // Update points display (cap at 9999 for display, matching game)
            const displayPoints = Math.min(currentPoints, 9999);
            currentPointsEl.textContent = displayPoints;
            nextRankPointsEl.textContent = depthInfo.max;
            pointsInputEl.value = currentPoints;

            // Calculate progress percentage
            const rangeSize = depthInfo.max - depthInfo.min;
            const progressInRange = Math.min(currentPoints, 9999) - depthInfo.min;
            const progressPercent = Math.min(100, Math.max(0, (progressInRange / rangeSize) * 100));

            // Update progress bar with a slight delay for animation
            setTimeout(() => {
                pointsBarEl.style.width = progressPercent + '%';
            }, 100);

            // Save to localStorage
            localStorage.setItem('deepOfNightPoints', currentPoints);
        }

        // Function to add points
        function addPoints(amount) {
            currentPoints = Math.min(10000, currentPoints + amount);
            updateDisplay();
        }

        // Function to subtract points
        function subtractPoints(amount) {
            currentPoints = Math.max(0, currentPoints - amount);
            updateDisplay();
        }

        // Function to set points directly
        function setPoints(points) {
            currentPoints = points;
            updateDisplay();
        }

        // Update from input field
        function updateFromInput() {
            const input = document.getElementById('pointsInput');
            const newPoints = parseInt(input.value) || 0;
            setPoints(Math.max(0, newPoints));
        }

        // Twitch IRC Integration
        function connectTwitch() {
            const channelInput = document.getElementById('twitchChannel');
            const channel = channelInput.value.trim().toLowerCase();

            if (!channel) {
                updateTwitchStatus('Enter channel name', 'error');
                return;
            }

            // Save channel name
            twitchChannel = channel;
            localStorage.setItem('twitchChannel', channel);

            // Close existing connection if any
            if (twitchWs) {
                twitchWs.close();
            }

            updateTwitchStatus('Connecting...', 'connecting');

            // Connect to Twitch IRC via WebSocket
            twitchWs = new WebSocket('wss://irc-ws.chat.twitch.tv:443');

            twitchWs.onopen = function() {
                // Anonymous connection (read-only)
                twitchWs.send('NICK justinfan12345');
                twitchWs.send('CAP REQ :twitch.tv/tags twitch.tv/commands');
                twitchWs.send(`JOIN #${channel}`);
            };

            twitchWs.onmessage = function(event) {
                const message = event.data;

                // Handle PING
                if (message.startsWith('PING')) {
                    twitchWs.send('PONG :tmi.twitch.tv');
                    return;
                }

                // Check if successfully joined
                if (message.includes('JOIN')) {
                    twitchConnected = true;
                    updateTwitchStatus('Connected', 'success');
                    updateToggleButton(true);
                }

                // Parse chat messages
                if (message.includes('PRIVMSG')) {
                    handleTwitchMessage(message);
                }
            };

            twitchWs.onerror = function(error) {
                console.error('Twitch connection error:', error);
                updateTwitchStatus('Connection error', 'error');
                twitchConnected = false;
                updateToggleButton(false);
            };

            twitchWs.onclose = function() {
                twitchConnected = false;
                updateTwitchStatus('Disconnected', 'disconnected');
                updateToggleButton(false);
            };
        }

        function disconnectTwitch() {
            if (twitchWs) {
                twitchWs.close();
                twitchWs = null;
            }
            twitchConnected = false;
            updateTwitchStatus('Disconnected', 'disconnected');
            updateToggleButton(false);
        }

        function toggleTwitch() {
            if (twitchConnected) {
                disconnectTwitch();
            } else {
                connectTwitch();
            }
        }

        function updateTwitchStatus(text, type) {
            const statusEl = document.getElementById('twitchStatus');
            statusEl.textContent = text;

            const colors = {
                'success': 'rgba(100, 255, 100, 0.8)',
                'error': 'rgba(255, 100, 100, 0.8)',
                'connecting': 'rgba(255, 200, 100, 0.8)',
                'disconnected': 'rgba(255, 255, 255, 0.5)'
            };

            statusEl.style.color = colors[type] || colors.disconnected;
        }

        function updateToggleButton(connected) {
            const toggleBtn = document.getElementById('twitchToggle');
            toggleBtn.textContent = connected ? 'Disconnect' : 'Connect';
        }

        function handleTwitchMessage(rawMessage) {
            // Parse Twitch IRC message
            const tags = {};
            const parts = rawMessage.split(' ');

            // Extract tags
            if (rawMessage.startsWith('@')) {
                const tagString = rawMessage.substring(1, rawMessage.indexOf(' :'));
                tagString.split(';').forEach(tag => {
                    const [key, value] = tag.split('=');
                    tags[key] = value;
                });
            }

            // Extract username
            const userMatch = rawMessage.match(/:(\w+)!\w+@\w+\.tmi\.twitch\.tv/);
            if (!userMatch) return;
            const username = userMatch[1];

            // Extract message
            const messageMatch = rawMessage.match(/PRIVMSG #\w+ :(.+)/);
            if (!messageMatch) return;
            const message = messageMatch[1].trim();

            // Check if it's a points command
            if (!message.startsWith('!don ')) return;

            // Check permissions (broadcaster or mod only)
            const isBroadcaster = username.toLowerCase() === twitchChannel.toLowerCase();
            const isMod = tags['mod'] === '1';
            const isVIP = tags['vip'] === '1';

            if (!isBroadcaster && !isMod) {
                console.log(`Ignoring command from ${username} (not broadcaster or mod)`);
                return;
            }

            // Parse the points value
            const pointsArg = message.substring(5).trim(); // Remove "!don "
            const pointsValue = parseInt(pointsArg);

            if (isNaN(pointsValue)) {
                console.log('Invalid points value:', pointsArg);
                return;
            }

            // Update points
            if (pointsValue >= 0) {
                addPoints(pointsValue);
                console.log(`${username} added ${pointsValue} points`);
            } else {
                subtractPoints(Math.abs(pointsValue));
                console.log(`${username} subtracted ${Math.abs(pointsValue)} points`);
            }
        }

        // Allow Enter key in input
        document.getElementById('pointsInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                updateFromInput();
            }
        });

        document.getElementById('twitchChannel').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                if (twitchConnected) {
                    disconnectTwitch();
                } else {
                    connectTwitch();
                }
            }
        });

        // Initialize on load
        updateDisplay();

        // Restore Twitch channel if saved and auto-connect
        if (twitchChannel) {
            document.getElementById('twitchChannel').value = twitchChannel;
            connectTwitch();
        }
    </script>
</body>
</html>